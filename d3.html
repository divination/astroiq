<!DOCTYPE html>
<html>
<head>
	<title>D3 Test</title>
	<script src="/js/lib/d3.v4.js" type="text/javascript" charset="utf-8"></script>
  <script src="/js/lib/d3-drag.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="/js/lib/d3-selection-multi.v0.4.min.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="/icomoon/style.css" />
<style>
	h1.title {
		position: absolute;
		font-family: Arial;
		color: #999999;
		top: 2vw;
		left: 2vw;
	}
</style>
</head>
<body>
<h1 class="title">D3 Test</h1>
<svg id="svg">
<style>
	#svg {
		width: 100%;
		height: 100%;
		max-width: 100vw;
		max-height: 100vh;
	}
	.main-disc {
		transform-origin: 50% 50% 0;
	}
  .house-label text {
    font-size: 3em;
  }

  .segment-symbol svg,
  .segment-symbol {
    width: 30px;
    height:  30px;
  }
  text {
  	opacity: 1;
  	transition: all 250s ease-in;
  	color: #99999;
  	font-family: Helvetica;
  }
  .invisible {
  	color: red;
  }


#north-indian-chart {
    opacity: 0;
    pointer-events: none;
}

.show-indian #north-indian-chart {
    opacity: 1;
    pointer-events: auto;
}

.show-indian #north-indian-chart .shape {
    stroke-width: 3px;
    stroke: blue;
}

.european-element {
    opacity: 1;
}

.european-element,
#north-indian-chart {
    transition: all 1s ease-in;
}

.show-indian .european-element {
    opacity: 0;
    pointer-events: none;
}

	</style>


  <g id="north-indian-chart" class="chart north-indian-chart" stroke="none" fill="none" transform="translate(60,60)" class="european-element">
      <path d="M0,0 L1440,0 L1440,1440 L0,1440 Z" stroke="none" class="shape" />
      <polygon
       id="zone-01"
       class="triangle zone shape"
       points="0,0 720,0 360,360" stroke="none"/>
      <polygon
       id="zone-02"
       class="triangle zone shape"
       points="0,0 0,720 360,360" stroke="none"/>
      <polygon
       id="zone-03"
       class="rect zone shape"
       points="720,0 360,360 720,720 1080,360" stroke="none" fill="yellow" />
       <polygon
       id="zone-04"
       class="triangle zone shape"
       points="0,720 0,1440 360,1080" stroke="none"/>
       <polygon
       id="zone-05"
       class="triangle zone shape"
       points="0,1440 720,1440 360,1080" stroke="none"/>
       <polygon
       id="zone-06"
       class="rect zone shape"
       points="0,720 360,360 720,720 360,1080" stroke="none" fill="yellow" />
       <polygon
       id="zone-07"
       class="triangle zone shape"
       points="720,0 1440,0 1080,360" stroke="none"/>
       <polygon
       id="zone-08"
       class="rect zone shape"
       points="720,1440 360,1080 720,720 1080,1080" stroke="none" fill="yellow" />
      <polygon
       id="zone-09"
       class="triangle zone shape"
       points="1440,720 1440,0 1080,360" stroke="none"/>
       <polygon
       id="zone-10"
       class="rect zone shape"
       points="1440,720 1080,360 720,720 1080,1080" stroke="none" fill="yellow" />
       <polygon
       id="zone-11"
       class="triangle zone shape"
       points="1440,720 1440,1440 1080,1080" stroke="none"/>
       <polygon
       id="zone-12"
       class="triangle zone shape"
       points="720,1440 1440,1440 1080,1080" stroke="none"/>
    </g>

</svg>
<script type="text/javascript" charset="utf-8" async defer>

Math.sinDeg = function(deg) {
	return Math.sin( (deg/180) * Math.PI);
}

Math.cosDeg = function(deg) {
	return Math.cos( (deg/180) * Math.PI);
}

Math.tanDeg = function(deg) {
	return Math.tan( (deg/180) * Math.PI);
}

Math.asinDeg = function(val) {
	return Math.asin( val ) * (180/Math.PI);
}

Math.acosDeg = function(val) {
	return Math.acos( val ) * (180/Math.PI);
}

Math.atanDeg = function(val) {
	return Math.atan( val ) * (180/Math.PI);
}

Array.prototype.max = function() {
	return Math.max.apply(Math, this);
}

Array.prototype.min = function() {
	return Math.min.apply(Math, this);
}


var dataArray = [132,167,23,235,430,52,34,590,720];

var width = 600, height = 600;

var widthScale = d3.scaleLinear()
	.domain([0,dataArray.max()])
	.range([0,width]);
var colorScale = d3.scaleLinear()
	.domain([0,dataArray.max()])
	.range(["yellow","blue"]);

var axis = d3.axisTop(widthScale).ticks(12);

var AstroChart = {

	diameter: 1500,

	mainOffset: 0,

	houses: [
		0,
		30,
		60,
		90,
		120,
		150,
		180,
		210,
		240,
		270,
		300,
		330
	],

  westernLayer: null,

  northIndianLayer: null,

  southIndianLayer: null,  

	houseLayer: null,

	houseLines: [],

	houseLabels: [],

	segments: [],

	segmentColors: [
		'#aa3300',
		'#00aa33',
		'#229944',
		'#448800',
		'#009966',
		'#990099',
		'#779922',
		'#3366cc',
		'#66cc66',
		'#cc0099',
		'#444499',
		'#3300cc'
	],

	svg: null,

	inner: null,

	main: null,

	degreeLayer: null,

  degreeLabels: null,

  discLayer: null,

  labelLayer: null,

	_xyPos: function(deg,pad,x,y) {
    if (!pad) {
      pad = 0;
    }
    if (!x) {
    	x = 0;
    }
    if (!y) {
    	y=0;
    }
    var d = this.diameter,r = (d/2)-pad;
    return {
      x: ( (Math.sinDeg(deg) * r) + r) + pad + x,
      y: Math.abs(0 - (Math.cosDeg(deg) * r) + r + pad) + y
    };
  },

	buildDegrees: function() {
		this.degreeLayer = this.main.append('g').attr('class','degrees');
		var labelOffset = this.diameter * (13/15),
		cls,offset,th,color,pos,dd,lb;
		
		for (var i=-90; i < 90; i++) {
			cls = 'degree-line';
			if (i%10===0) {
				offset = 120;
				th = 2;
				cls += ' degree-line-ten';
				color = 'black';
			} else if (i%5===0) {
				offset = 130;
				th = 1;
				cls += ' degree-line-five';
				color = '#333333';
			} else {
				offset = 140;
				th = 1;
				color = '#999999';
			}
			this.degreeLayer.append('line')
			.attr('class',cls)
			.attr('x1',this.radius)
			.attr('y1',offset)
			.attr('x2',this.radius)
			.attr('y2',(this.diameter-offset))
			.attr('stroke',color)
			.attr('stroke-width',th)
			.attr('transform','rotate('+i+',750,750)');
      if (i%30===0) {
        pos = this._xyPos(i,100);
        dd = 270-i;
        if (dd==360) {
          dd =0;
        }
        lb = this.degreeLayer.append('text')
        .text(dd + 'ยบ')
        .attr('x',pos.x)
        .attr('y',pos.y);
        pos = this._xyPos((i+180),100);
        dd = 270-(i + 180);
        this.degreeLabels.push(lb);
        lb = this.degreeLayer.append('text')
        .text(dd + 'ยบ')
        .attr('x',pos.x)
        .attr('y',pos.y);
        this.degreeLabels.push(lb);
      }
		}
	},

	_segmentPathCoords: function(radius,deg,inset) {
		var cos = Math.cosDeg(30),
			sin=Math.sinDeg(30),
			y = radius + inset,
		s2 = radius - (cos * radius) + inset;
		s1 = radius + (sin * radius) + inset;
		return 'M'+y+','+inset+' A'+radius+','+radius+' 0 0,1 '+s1+','+s2+' L'+y+','+y+' Z';
	},

	buildMain: function() {
		
    this.discLayer = this.main.append('g').attr('class','main-segments');
    this.labelLayer = this.main.append('g').attr('class','segment-symbols');
		this.segments=[];
			var segCoords = this._segmentPathCoords((this.radius*0.8),30,(this.radius*0.2)),
			deg = 0,
			segment,npad,pos;
		for (var i=0;i<12;i++) {
			deg = i * 30;
      deg = (270-deg);
			segment =this.discLayer.append('path')
			.attr('class','segment segment-' + (i+1))
			.attr('d',segCoords)
			.attr('fill',this.segmentColors[i])
			.attr('transform','rotate('+deg+',750,750)');
			this.segments.push(segment);
      npad = (i+1);
      if (npad<10) {
        npad = '0' + npad;
      }
      pos = this._xyPos((deg-15),190);
      
      this.labelLayer.append('image')
      	.attr('href','/svgs/signs/glyph/'+npad+'.svg')
        .attr('class','segment-symbol segment-symbol-' + i)
        .attr('x',(pos.x-10))
        .attr('y',(pos.y-10));

        
		}
	},

	buildInner: function() {
		this.inner = this.svg.append('g').attr('class','inner-disc');
		this.inner.append('circle')
			.attr('class','inner-disc')
			.attr('cx',this.radius)
			.attr('cy',this.radius)
			.attr('r',this.radius * (2/3))
			.attr('fill','white');
			var step = 1;
	},

  tweenDegreeLabels: function(deg) {
    var i=0, num=AstroChart.degreeLabels.length,lb,x,y;
    for (;i<num;i++) {
      lb = AstroChart.degreeLabels[i];
      x = lb.attr('x');
      y = lb.attr('y');
      lb.attr('transform','rotate('+(0-deg)+','+x+','+y+')');
    }
  },

  tweenMain: function(deg) {
  	AstroChart.mainOffset = deg;
    AstroChart.tweenDegreeLabels(deg);
  	AstroChart.main.transition()
			.duration(2000)
			.attrTween("transform", function() {
	      var i = d3.interpolate(0, AstroChart.mainOffset);
	      return function(t) {
	          return "rotate(" + i(t) + ","+AstroChart.radius+","+AstroChart.radius+")";
	      };
	  });

  },

  tweenHouses: function(newHouses) {
  	var numNewHouses = newHouses.length;
  	for (var i=0;i<numNewHouses;i++) {
      deg = 270-newHouses[i];
      this.houseLines[i].attr('data-next-deg',deg).transition()
      .delay(1500)
      .duration(1000)
      .attrTween('transform',function(){
        var it = d3.select(this),
          oldDeg = it.attr('data-deg'),
          nextDeg = it.attr('data-next-deg');
          it.attr('data-deg',nextDeg);
          var inter = d3.interpolate(oldDeg, nextDeg);
          return function(t) {
              return "rotate(" + inter(t) + ",750,750)";
          };
      });
      this.houseLabels[i]
      	.attr('data-next-deg',deg)
      	.classed('invisible',true)
      .transition()
      .delay(2250)
      .attrTween('transform',function(){
        var it = d3.select(this),
          oldDeg = it.attr('data-deg'),
          nextDeg = it.attr('data-next-deg');
          var pos = AstroChart._xyPos((nextDeg-5),40,-36,-40);
          it.classed('invisible',false);
          return function(t) {
              return 'translate('+pos.x+','+pos.y+')';
          };
      });
    }
  },

  buildHouses: function() {
  	this.houseLayer = this.svg.append('g').attr('class','house-lines-group');
    this.houseLines = [];
    this.houseLabels = [];
    var numHouses = this.houses.length,
      colors = ['#550000','#005500','#000055'],
      pos, cls,deg, lbl, cg, cc;
    for (var i=0;i<numHouses;i++) {
      color = colors[(i%colors.length)];
      cls = 'house-line house-line-' + (i+1);
      if (i===0) {
        cls += ' ascendant';
      }
      if (i < (numHouses/2)) {
        deg = this.houses[i];
      } else {
        deg = 180 + this.houses[(i-(numHouses/2))];
        this.houses[i] = deg;
      }
      deg = 270-deg;
      this.houseLines[i] = this.houseLayer.append('line')
        .attr('class',cls)
        .attr('data-deg',deg)
        .attr('x1',750)
        .attr('y1',0)
        .attr('x2',750)
        .attr('y2',750)
        .attr('stroke',color)
        .attr('stroke-width',3)
        .attr('transform','rotate('+deg+',750,750)');
        
        
      pos = this._xyPos((deg-5),40,-36,-40);
      cg = this.houseLayer.append('g')
      .attr('data-deg',deg)
      .attr('class','house-label house-label-' + (i+1))
      .attr('transform','translate('+pos.x+','+pos.y+')');
      cc = cg.append('circle')
      .attr('cx',40)
      .attr('cy',40)
      .attr('r',40)
      .attr('fill','white');
      
      lbl = cg.append('text')
      .text((i+1))
      .attr('x',20)
      .attr('y',50);
      this.houseLabels[i] = cg;
    }
  },


	init: function() {
		this.radius = this.diameter/2;
		this.svg = d3.select('#svg')
			.attr('width',this.diamter)
			.attr('height',this.diamter)
			.attr('viewBox','0 0 '+this.diameter+' '+this.diameter);
    this.westernLayer = this.svg.append('g')
      .attr('class','western-chart');
    this.main = this.svg.append('g')
      .attr('class','main-disc')
      .attr('x',90)
      .attr('y',90);
    this.degreeLabels = [];
		this.buildDegrees();
		this.buildMain();
		this.buildInner();
		this.buildHouses();

    function xyDeg(diam,x,y,offset) {
      if (typeof offset !== 'number') {
        offset = 0;
      }
      var r = (diam/2) - offset;
      var x2 = ((x-offset) / r) -1, y2 = 2- ((y-offset) / r) -1,
       deg1 = Math.asinDeg(x2), deg2 =Math.acosDeg(y2);
       if (deg1 < 0) {
         deg2 = 360 - deg2;
       }
      return deg2;
    }

    function move(){
      //this.parentNode.appendChild(this);
      var dt = d3.select(this),newDeg=0,tr = dt.attr('transform');
      if (tr != undefined) {
        newDeg = tr.split('(').pop().split(',').shift()-0;
      }
      
      
      var pDeg = dt.attr('data-drag');
      if (!pDeg) {
        pDeg = 0;
      } else {
        pDeg = pDeg-0;
      }
      var cDeg = xyDeg(1500,d3.event.x,d3.event.y,150),
      dDeg = cDeg-pDeg;
      if (cDeg > pDeg || dDeg < -30) {
        newDeg += 0.5;
      } else {
        newDeg -= 0.5;
      }
      if (Math.abs(dDeg) > 0.2) {
        if (newDeg >= 360) {
          newDeg -= 360;
        }
        AstroChart.tweenDegreeLabels(newDeg);
        if (!isNaN(cDeg)) {
          dt.attr('data-drag',cDeg);
          dt.attr("transform",'rotate('+newDeg+',750,750)');
        }
      }
      
    };

    this.main.call(d3.drag()
        .on("start", function(d, i){
          //console.log(d3.event.dx)
        })
        .on("drag", move)
        .on("end", function(d, i){
          //console.log(d3.event.dx,d3.event.dy)
        })
    );

		this.main.on('click',function(){
			
			newHouses = [
				98,
				113,
				156,
				181,
				207,
				244,
				278,
				303,
				336,
				1,
				27,
				64
			];
			var ascendant = newHouses[0];
			console.log(0-ascendant)
			AstroChart.tweenMain(ascendant);
			for (var i=0;i<newHouses.length;i++) {
				newHouses[i] -= ascendant;
			}
			AstroChart.tweenHouses(newHouses);
		});
	}

}

AstroChart.init();

</script>
</body>
</html>